## 1. 실습 주제

버튼 입력으로 조작하는 16×16 LED 매트릭스 **Snake Game** 구현

## 2. 프로젝트 개요

네 방향 버튼 입력을 읽어 뱀의 진행 방향을 결정하고, 일정 주기로 **이동 → 충돌 검사 → 먹이 섭취/성장 → 보드 렌더링**을 반복합니다. 먹이를 먹을수록 길이가 늘고 속도가 빨라집니다.

## 3. 개념 설명 (알고리즘 소개)

* **그리드 이동 알고리즘**: 현재 머리 좌표에 방향 벡터 ((dx,dy))를 더해 새로운 머리 좌표를 얻습니다.
* **충돌 판정**: 새 머리가 경계 밖이거나 몸 좌표 집합에 포함되면 게임 오버입니다.
* **성장 규칙**: 새 머리가 먹이 칸이면 꼬리를 줄이지 않아 길이가 +1 됩니다.
* **레벨/속도 조절**: 점수(=먹이 수)에 비례해 이동 주기를 짧게 하여 난이도를 상승시킵니다.
* **랜덤 배치**: 뱀·먹이 좌표와 겹치지 않는 빈 칸에 먹이를 추가합니다.

## 4. 코드 전체

```python
from machine import Pin, Timer
from ticle.ext import WS2812Matrix
import utime
import urandom

W = 16
H = 16

UP_PIN = 18
LEFT_PIN = 19
DOWN_PIN = 20
RIGHT_PIN = 21

btn_up = Pin(UP_PIN, Pin.IN)
btn_left = Pin(LEFT_PIN, Pin.IN)
btn_down = Pin(DOWN_PIN, Pin.IN)
btn_right = Pin(RIGHT_PIN, Pin.IN)

m = WS2812Matrix([(3,1)])
m.clear()

SNAKE_HEAD = (0, 255, 255)
SNAKE_BODY = (20, 100, 40)
FOOD = (200, 40, 0)
EMPTY = (0, 0, 0)
WALL = (10, 10, 10)

def rnd(n):
    b = urandom.getrandbits(16)
    return b % n

def place_foods(snake, foods, target_cnt):
    while len(foods) < target_cnt:
        x = rnd(W)
        y = rnd(H)
        p = (x, y)
        if p not in snake and p not in foods:
            foods.append(p)

def draw_pixel(x, y, c):
    if 0 <= x < W and 0 <= y < H:
        m[x, y] = c

def draw_board(snake, foods):
    for y in range(H):
        for x in range(W):
            m[x, y] = EMPTY
    for i, p in enumerate(snake):
        draw_pixel(p[0], p[1], SNAKE_HEAD if i == 0 else SNAKE_BODY)
    for fx, fy in foods:
        draw_pixel(fx, fy, FOOD)
    m.update()

def read_dir(cur_dir):
    ux = 1 if btn_up.value() else 0
    dx = 1 if btn_down.value() else 0
    lx = 1 if btn_left.value() else 0
    rx = 1 if btn_right.value() else 0
    if ux and cur_dir != (0, 1):
        return (0, -1)
    if dx and cur_dir != (0, -1):
        return (0, 1)
    if lx and cur_dir != (1, 0):
        return (-1, 0)
    if rx and cur_dir != (-1, 0):
        return (1, 0)
    return cur_dir

def move(snake, direction, grow):
    hx, hy = snake[0]
    nx = hx + direction[0]
    ny = hy + direction[1]
    if nx < 0 or nx >= W or ny < 0 or ny >= H:
        return None, False
    if (nx, ny) in snake:
        return None, False
    new_head = (nx, ny)
    if grow:
        new_snake = [new_head] + snake
    else:
        new_snake = [new_head] + snake[:-1]
    return new_snake, True

def level_delay(score):
    base = 240
    dec = min(score * 4, 120)
    d = base - dec
    if d < 120:
        d = 120
    return d

def flash_game_over(snake):
    for _ in range(4):
        for p in snake:
            draw_pixel(p[0], p[1], (180, 0, 0))
        m.update()
        utime.sleep_ms(120)
        for p in snake:
            draw_pixel(p[0], p[1], (0, 0, 0))
        m.update()
        utime.sleep_ms(120)

def game():
    m.clear()
    start = (W // 2, H // 2)
    snake = [start, (start[0]-1, start[1]), (start[0]-2, start[1])]
    direction = (1, 0)
    foods = []
    score = 0
    target_foods = 2 + (urandom.getrandbits(1) & 1)
    place_foods(snake, foods, target_foods)
    draw_board(snake, foods)
    last_turn = utime.ticks_ms()
    while True:
        direction = read_dir(direction)
        delay = level_delay(score)
        now = utime.ticks_ms()
        if utime.ticks_diff(now, last_turn) >= delay:
            last_turn = now
            grow = False
            hx, hy = snake[0]
            if (hx, hy) in foods:
                grow = True
                foods.remove((hx, hy))
            new_snake, ok = move(snake, direction, grow)
            if not ok:
                flash_game_over(snake)
                break
            snake = new_snake
            if grow:
                score += 1
                place_foods(snake, foods, target_foods)
            draw_board(snake, foods)

while True:
    game()
    utime.sleep_ms(600)
```

## 5. 코드 요약

### 5-1) 보드·색상·입력 준비

```python
W,H=16,16
btn_up=Pin(18,Pin.IN); btn_left=Pin(19,Pin.IN)
btn_down=Pin(20,Pin.IN); btn_right=Pin(21,Pin.IN)
m=WS2812Matrix([(3,1)]); m.clear()
```

* 16×16 보드와 4방향 버튼을 설정합니다.
* 매트릭스를 초기화하고 색상 상수로 머리/몸/먹이/빈칸을 구분합니다.

<br>

### 5-2) 랜덤·먹이 배치

```python
def rnd(n): return urandom.getrandbits(16)%n

def place_foods(snake, foods, target_cnt):
    while len(foods) < target_cnt:
        p=(rnd(W), rnd(H))
        if p not in snake and p not in foods:
            foods.append(p)
```

* 균등 난수로 좌표를 뽑고, **뱀·기존 먹이와 겹치지 않는 빈 칸**에만 추가합니다.

<br>

### 5-3) 렌더링(그리기)

```python
def draw_board(snake, foods):
    for y in range(H):
        for x in range(W):
            m[x,y]=EMPTY
    for i,p in enumerate(snake):
        m[p[0],p[1]] = SNAKE_HEAD if i==0 else SNAKE_BODY
    for fx,fy in foods:
        m[fx,fy]=FOOD
    m.update()
```

* 매 프레임 전체를 비우고, **머리→몸→먹이** 순으로 색을 찍은 뒤 `update()`로 표시합니다.

<br>

### 5-4) 방향 입력 처리(역주행 금지)

```python
def read_dir(cur_dir):
    ux,dx,lx,rx = btn_up.value(), btn_down.value(), btn_left.value(), btn_right.value()
    if ux and cur_dir != (0, 1):  return (0, -1)
    if dx and cur_dir != (0,-1):  return (0, 1)
    if lx and cur_dir != (1, 0):  return (-1,0)
    if rx and cur_dir != (-1,0):  return (1, 0)
    return cur_dir
```

* 반대 방향으로의 즉시 전환(자살)을 막습니다.
* 여러 버튼이 동시에 눌려도 **첫 조건**만 적용되어 안정적으로 동작합니다.

<br>

### 5-5) 이동·충돌·성장

```python
def move(snake, direction, grow):
    hx,hy=snake[0]
    nx,ny=hx+direction[0], hy+direction[1]
    if nx<0 or nx>=W or ny<0 or ny>=H:        return None, False
    if (nx,ny) in snake:                       return None, False
    new_head=(nx,ny)
    new_snake=[new_head]+(snake if grow else snake[:-1])
    return new_snake, True
```

* **경계/자기충돌**을 먼저 검사합니다.
* 먹이를 먹었다면 꼬리를 유지해 길이가 1 증가합니다.

<br>

### 5-6) 속도(레벨) 조절

```python
def level_delay(score):
    base=240; dec=min(score*4,120)
    d=max(base-dec, 120)
    return d
```

* 점수가 오를수록 딜레이를 줄여 **점진적으로 빠르게** 만듭니다(최소 120ms).

<br>

### 5-7) 게임 루프

```python
snake=[(W//2,H//2),(W//2-1,H//2),(W//2-2,H//2)]
direction=(1,0); foods=[]; score=0
target_foods=2 + (urandom.getrandbits(1) & 1)
place_foods(snake, foods, target_foods)
last_turn=utime.ticks_ms()

while True:
    direction=read_dir(direction)
    if utime.ticks_diff(utime.ticks_ms(), last_turn) >= level_delay(score):
        last_turn=utime.ticks_ms()
        grow=False
        if snake[0] in foods:
            grow=True; foods.remove(snake[0])
        new_snake, ok = move(snake, direction, grow)
        if not ok:
            flash_game_over(snake); break
        snake=new_snake
        if grow:
            score+=1
            place_foods(snake, foods, target_foods)
        draw_board(snake, foods)
```

* **주기적 틱**마다 한 칸 이동하고, 먹이면 성장·리스폰, 아니면 일반 이동을 수행합니다.
* 충돌 시 **점멸 연출** 후 루프를 종료합니다.

## 6. 결과 확인

버튼으로 방향을 바꾸며 먹이를 먹으면 길이가 늘고, 이동 속도가 점점 빨라집니다. 벽 밖으로 나가거나 몸에 부딪히면 게임 오버가 점멸로 표시됩니다.

## 7. 연습문제

1. 색상 테마 변경: `SNAKE_HEAD`, `SNAKE_BODY`, `FOOD`를 다른 팔레트로 바꿔 보세요.
2. 난이도 조절: `level_delay()`의 `base`·`dec`·최소값을 조정해 체감 속도를 바꿔 보세요.
3. 먹이 개수 변형: `target_foods` 범위를 1~3으로 바꾸어 플레이 감각을 비교해 보세요.
