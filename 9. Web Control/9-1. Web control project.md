# PBL 실습형 교재 문서 (PC–Pico 연동형)

## 1. 실습 주제

**웹에서 제어하는 원격 LED 조명 시스템 구현**


## 2. 프로젝트 개요

이 실습에서는 **PC의 웹 브라우저**와 **Raspberry Pi Pico W**가
서로 통신하여 LED 매트릭스의 색상을 실시간으로 제어합니다.

* **PC (Flask 서버)** → 웹 페이지에서 색상 선택 후 전송
* **Pico W (클라이언트)** → 수신한 데이터를 LED 색상으로 표시

즉, Flask 웹 서버를 통해 사용자가 웹 인터페이스에서 색을 선택하면,
그 정보가 Pico에 전달되어 **조명 색상이 즉시 바뀌는 구조**입니다.

## 3. 선행 작업

(이곳에 Flask 설치 및 Python 환경 준비 과정을 기술하세요.)
📋 예시: “Flask 설치 명령어”, “Python 가상환경 설정”, “MQTT 브로커 접속 테스트” 등

## 4. 개념 설명 — **Flask 웹 서버 구조 이해하기**

**Flask란?**
Flask는 파이썬 기반의 **경량 웹 프레임워크**로,
복잡한 설정 없이 빠르게 웹 서버와 API를 구성할 수 있습니다.

주요 특징은 다음과 같습니다.

* **라우팅 (Routing):**
  `@app.route()` 데코레이터를 사용해 URL과 함수를 연결합니다.
  예:

  ```python
  @app.route("/")
  def index():
      return "Hello Flask!"
  ```

* **템플릿 렌더링 (HTML 표시):**
  `render_template()` 함수를 이용해 HTML 파일을 클라이언트에 전송합니다.
  HTML 파일은 기본적으로 `templates/` 폴더에 저장됩니다.

* **요청 처리 (Request Handling):**
  GET, POST 등 HTTP 요청을 처리하며,
  `request.form`이나 `request.args`를 통해 사용자의 입력 데이터를 가져옵니다.

* **서버 실행:**
  Flask는 내부 개발용 서버를 내장하고 있으며,
  다음과 같이 간단히 실행할 수 있습니다.

  ```python
  if __name__ == "__main__":
      app.run(host="0.0.0.0", port=5000)
  ```

이번 실습에서는 Flask가 웹 인터페이스를 담당하고,
색상 값을 입력받아 MQTT를 통해 Pico로 전송하는 역할을 합니다.
즉, Flask는 **사용자와 하드웨어 사이의 다리(Bridge)** 역할을 합니다.

## 5. Pico 코드

```python
from ticle import WifiManager
from umqtt.simple2 import MQTTClient
from ticle.ext import WS2812Matrix
import utime

MATRIX_W=16; MATRIX_H=16
TOPIC=b"ticle/ws2812/color"

led_matrix=WS2812Matrix([(3,1)])
led_matrix.clear()

def fill_color_hex(hex_string):
    if len(hex_string)==7 and hex_string[0]==35:
        r=int(hex_string[1:3],16)
        g=int(hex_string[3:5],16)
        b=int(hex_string[5:7],16)
        for y in range(MATRIX_H):
            for x in range(MATRIX_W):
                led_matrix[x,y]=(r,g,b)
        led_matrix.update()

def on_message(topic,msg,retained,dup):
    fill_color_hex(msg)

wifi=WifiManager()
wifi.connect("HBE_RSP","hanback91!")

mqtt_client=MQTTClient("pico_ws2812","test.mosquitto.org",port=1883)
mqtt_client.set_callback(on_message)
mqtt_client.connect()
mqtt_client.subscribe(TOPIC)

while True:
    mqtt_client.check_msg()
    utime.sleep_ms(20)
```

## 6. PC 코드

```python
from flask import Flask, render_template, request, make_response
import paho.mqtt.client as mqtt
import os

BROKER = "test.mosquitto.org"
PORT = 1883
TOPIC = "ticle/ws2812/color"

client = mqtt.Client(client_id=f"pc_ws2812_{os.getpid()}", clean_session=True)
client.connect(BROKER, PORT, 60)
client.loop_start()

app = Flask(__name__)

@app.route("/", methods=["GET"])
def index():
    return render_template("index.html")

@app.route("/set", methods=["POST"])
def set_color():
    color_value = request.form.get("color", "").strip()
    if not color_value.startswith("#") or len(color_value) != 7:
        return make_response("Invalid color format", 400)
    client.publish(TOPIC, payload=color_value.encode(), qos=0, retain=False)
    return "ok"

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
```


### 🧠 (A) Pico 코드 요약

* `WifiManager`를 통해 무선 네트워크에 연결
* MQTT 클라이언트로 `test.mosquitto.org` 브로커 구독
* 수신 메시지(색상 코드)를 해석하여 LED 매트릭스 색상 변경
* 20ms 간격으로 지속적으로 메시지 체크

### 💻 (B) PC 코드 요약

* **Flask 서버 구성:**
  `/` 경로에서 HTML 페이지를 표시하고,
  `/set` 경로에서 POST 요청을 처리합니다.
* **색상 처리 흐름:**

  1. 웹 페이지에서 색상(`#RRGGBB`)을 선택
  2. `/set`로 POST 전송
  3. Flask가 값을 검증 후 MQTT로 전송
* **서버 실행:**
  `app.run()`으로 5000번 포트에서 웹 서버 실행

## 8. 결과 확인

웹 브라우저에서 색상을 선택하고 “전송”을 누르면,
Pico의 WS2812 LED 매트릭스가 동일한 색으로 변합니다.
PC에서 웹 UI를 통해 **실시간으로 조명 색상을 원격 제어**할 수 있습니다.

📸 **사진 / 스크린샷 삽입 위치 (웹 UI, LED 표시 결과)**
(여기에 Flask 웹 페이지와 Pico LED 매트릭스의 결과 사진을 첨부하세요.)

## 9. 연습문제

1. 웹 페이지에 여러 색상 버튼(예: “Red”, “Green”, “Blue”)을 추가해보세요.
2. 색상 변경 시, LED 매트릭스의 밝기나 애니메이션 효과를 추가해보세요.
3. 웹 페이지에 “모두 끄기” 버튼을 추가하여 LED를 전체 소등하는 기능을 만들어보세요.
